name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [published]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  actions: write
  contents: write
  id-token: write
  attestations: write

jobs:
  # Stage 1: Trigger Lint Workflow
  trigger-lint:
    name: Trigger Lint and Format
    runs-on: ubuntu-latest
    steps:
      - name: Trigger lint workflow
        uses: actions/github-script@v7
        with:
          script: |
            // Note: We need to handle different ref formats for workflow dispatch
            // - Pull requests: context.ref is 'refs/pull/X/merge' (invalid for dispatch)
            // - Pushes: context.ref is 'refs/heads/branch-name' (needs cleaning)
            // - We extract the actual branch name for workflow dispatch

            // Debug context information
            console.log(`Event: ${context.eventName}`);
            console.log(`Original ref: ${context.ref}`);
            console.log(`Repo: ${context.repo.owner}/${context.repo.repo}`);

            // Use the correct ref for workflow dispatch
            let targetRef = context.ref;

            // For pull requests, use the head ref (source branch) instead of the merge ref
            if (context.eventName === 'pull_request') {
              targetRef = context.payload.pull_request.head.ref;
              console.log(`PR head ref: ${targetRef}`);
            }

            // For pushes, use the branch name
            if (context.eventName === 'push') {
              targetRef = context.ref.replace('refs/heads/', '');
              console.log(`Push branch: ${targetRef}`);
            }

            console.log(`Final target ref: ${targetRef}`);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'lint.yml',
              ref: targetRef,
              inputs: {
                trigger_source: 'ci-pipeline'
              }
            });

            console.log('Lint workflow triggered successfully');
